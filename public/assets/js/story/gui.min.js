function story_access_resp(a){if(!a.valid&&null!=a.errorCode)switch(a.errorCode){case 201:showLogin&&showLogin();break;case 302:showLogin&&showLogin();break;case 303:gui.hideConcept(),accessGateway.ep3(a);break;case 304:gui.hideConcept(),accessGateway.ep4(a);break;case 202:case 102:case 101:default:a.errorMessage&&""!=a.errorMessage&&msgCenter.send(a.errorMessage,1e4)}}function constructDomComment(a){if(!a)return $("");var b=new Date(1e3*a.date);b.getDate()+"/"+(b.getMonth()+1);var d="<li>";return d+='<img class="comment_avatar" src="'+a.avatar+'"/>',d+='<div class="comment_body">',d+='<div class="arrow"></div>',d+="<h5>"+a.content+"</h5>",d+=""!=a.image?'<img class="comment_image" src="'+a.image+'"/>':"",d+='<div class="comment_footer">',d+="<h5>De "+a.user+"</h5>",a.fbpostid&&(d+='<a class="comment_fblike" data-postid="'+a.fbpostid+'"></a>',d+='<a class="comment_fblink" href="http://www.facebook.com/'+a.fbpostid+'" target="_blank"></a>'),d+="</div>",d+="</div>",d+="</li>",$(d)}var mmvc=function(){var observe=function(a,b){this._mmvclisteners[a].push(b)},notify=function(a,b){for(var c=this._mmvclisteners[a],d=0;c.length>d;++d)c[d].invoke(b)},addObservableVars=function(vars){if(vars instanceof Array)for(var i=0;vars.length>i;++i){var variable=vars[i];this["set"+variable]?this._mmvclisteners[variable]||(this._mmvclisteners[variable]=[]):(this._mmvclisteners[variable]||(this._mmvclisteners[variable]=[]),eval("this.set"+variable+" = function(value) {this."+variable+" = value; this.notify('"+variable+"', value);}"))}};return{makeModel:function(a,b){if(a instanceof Object){if(a.notify||a.observe||a.addObservableVars)return console.error("Model has his own observe, notify and/or addObservableVars method"),void 0;a._mmvclisteners={},a.observe=observe,a.notify=notify,a.addObservableVars=addObservableVars,a.addObservableVars(b)}}}}(),accessGateway={success:!1,buyClicked:function(a,b){var c=confirm("MERCI\nTu es l\u2019un de nos premiers clients. Pour te remercier, nous t\u2019offrons gratuitement le "+a+"\u00e8me \u00e9pisode de Voodoo Connection.");c&&(b&&$.ajax({url:window.config.base_url+b,type:"POST",async:!1,dataType:"json",data:{epid:a}}),window.open(window.config.publicRoot+"story?ep="+a,"_newtab"))},ep3:function(){$("#access_dialog").attr("class","dialog invitation_dialog"),$("#access_dialog h1").text("Invitation");var b=$("#access_dialog");FB.XFBML.parse(),FB.Event.subscribe("message.send",function(){$.ajax({url:window.config.publicRoot+"accessaction/invitation_fb",type:"POST",dataType:"json",success:function(a){a&&a.valid&&a.valid===!0?accessGateway.success=!0:a&&a.errorMessage?alert(a.errorMessage):alert("Une erreur de connexion est survenue.")},error:function(){alert("Une erreur de connexion est survenue.")}}),$("#access_dialog #fbsend_section").nextAll().remove(),$("#access_dialog #fbsend_section").append("<p><input id='send_fb_btn' type='submit' value=\"Acc\u00e8de \u00e0 l'\u00e9pisode 3\"></p>"),$("#send_fb_btn").click(function(a){a.preventDefault(),accessGateway.success&&(accessGateway.success=!1,b.removeClass("show"),window.open(window.config.publicRoot+"Voodoo_Connection/season1/episode3","_newtab"))})});var c={type:"POST",async:!1,dataType:"json",success:function(a){a&&a.valid&&a.valid===!0?(b.removeClass("show"),accessGateway.success=!0):a&&a.errorMessage?alert(a.errorMessage):alert("Une erreur de connexion est survenue.")},error:function(){alert("Une erreur de connexion est survenue.")}};$("#invitation_form").ajaxForm(c),$("#send_mail_btn").click(function(a){a.preventDefault(),fuel_set_csrf_token($("#invitation_form").get(0)),$("#invitation_form").submit(),accessGateway.success&&(accessGateway.success=!1,window.open(window.config.publicRoot+"Voodoo_Connection/season1/episode3","_newtab"))}),b.addClass("show"),$("#access_buy_btn3").unbind("click").click(function(){b.removeClass("show")})},ep4:function(){$("#access_dialog").attr("class","dialog like_dialog"),$("#access_dialog h1").text("J'aime SEASON13 sur Facebook");var b=$("#access_dialog");FB.XFBML.parse(),FB.Event.subscribe("edge.create",function(){$.ajax({url:window.config.publicRoot+"accessaction/liked",type:"POST"}),$("#access_dialog #like_section fb").nextAll().remove(),$("#access_dialog #like_section").append("<p><input id='access_submit_btn4' type='submit' value=\"Acc\u00e8de \u00e0 l'\u00e9pisode 4\"></p>")});var c={type:"POST",async:!1,dataType:"json",success:function(a){a&&a.valid&&a.valid===!0?(b.removeClass("show"),accessGateway.success=!0):a&&a.errorMessage?alert(a.errorMessage):alert("Une erreur de connexion est survenue.")},error:function(){alert("Une erreur de connexion est survenue.")}};$("#like_form").ajaxForm(c),$("#access_submit_btn4").live("click",function(a){a.preventDefault(),fuel_set_csrf_token($("#like_form").get(0)),$("#like_form").submit(),accessGateway.success&&(accessGateway.success=!1,window.open(window.config.publicRoot+"Voodoo_Connection/season1/episode4","_newtab"))}),fbapi.connect(function(){var a=fbapi.user.id,b='SELECT%20user_id%20FROM%20url_like%20WHERE%20url%3D"http://season13.com/"%20AND%20user_id%3D'+a,c="/fql?q="+b;FB.api(c,"get",function(a){a&&a.data&&(a.data.length>0?$("#access_dialog #like_section").html("<h5>Bravo! Tu as d\u00e9j\u00e0 aim\u00e9 SEASON13 sur Facebook, nous t'offrons le 4\u00e8me \u00e9pisode de Voodoo Connection.<br/></h5><p><input id='access_submit_btn4' type='submit' value=\"Acc\u00e8de \u00e0 l'\u00e9pisode 4\"></p>").nextAll().remove():a.error&&console.log("Error: "+a.error.message))})}),b.addClass("show"),$("#access_buy_btn4").unbind("click").click(function(){$(".center #access_dialog").removeClass("show")})}};gui={},gui.Slider=function(a,b,c,d){this.jqObj=$("<div class='slider'></div>"),this.line=$("<div class='line'></div>"),this.btn=$("<div class='ctrlbtn'></div>"),this.back=$("<img class='background' src='"+config.base_url+"assets/img/season13/ui/slider_back.png'/>"),this.jqObj.append(this.back).append(this.line).append(this.btn),isNaN(a)||this.jqObj.css("width",a),this.width=this.jqObj.width()-this.btn.width(),this.level=isNaN(b)?100:b,this.step=this.width/(this.level-1),this.value=0,this.ondrag=!1,this.appendTo(c),this.dragStartHandlerCB=new Callback(this.dragStartHandler,this),this.draggingHandlerCB=new Callback(this.draggingHandler,this),this.moveBtnCB=new Callback(this.moveBtn,this),mmvc.makeModel(this,["value"]),this.observe("value",this.moveBtnCB),isNaN(d)&&(d=0),this.setvalue(d),this.btn.mseInteraction().mseInteraction("addListener","gestureSingle",this.dragStartHandlerCB,!0),this.back.mseInteraction().mseInteraction("addListener","gestureSingle",this.draggingHandlerCB,!0)},gui.Slider.prototype={constructor:gui.Slider,appendTo:function(a){return this.jqObj&&a instanceof jQuery?(a.append(this.jqObj),this.jqObj.css({top:(a.height()-this.jqObj.height())/2}),this.jqObj):null},moveBtn:function(a){var b=a*this.step-9;0>b&&(b=0),this.btn.css("left",b),this.line.css("width",b)},dragStartHandler:function(a){"gestureStart"==a.type?this.startDrag(a):"gestureUpdate"==a.type?this.dragging(a):"gestureEnd"==a.type&&this.endDrag(a)},draggingHandler:function(a){"gestureUpdate"==a.type?this.dragging(a):"gestureEnd"==a.type&&this.endDrag(a)},startDrag:function(){this.ondrag=!0},dragging:function(a){if(this.ondrag){var b=a.windowX-this.back.offset().left;b>this.width?b=this.width:0>b&&(b=0);var c=Math.ceil(b/this.step);this.setvalue(c)}},endDrag:function(){this.ondrag=!1}},gui.downloadTimeout=function(){},gui.removeDownloadTimer=function(a){a=a?a:gui.downloadTimer,clearTimeout(a)},gui.openhideMenu=function(a){a.stopPropagation(),gui.menu.hasClass("active")?(gui.menu.removeClass("active"),$("#icon_menu").removeClass("active"),$("#switch_menu").removeClass("active")):(gui.menu.addClass("active"),$("#icon_menu").addClass("active"),$("#switch_menu").addClass("active"))},gui.openPref=function(){gui.center.hasClass("show")||gui.center.addClass("show"),gui.pref.hasClass("show")||(gui.pref.siblings().removeClass("show"),gui.pref.addClass("show"),window.mse&&(mse.root.pause(),gui.updatePlayPauseIcon()))},gui.savePersonalData=function(){mse.configs.user?(gui.prefSaveLoading.show(),userData.save(function(){msgCenter.send("Tes configurations sont mise \u00e0 jour."),gui.prefSaveLoading.hide()},function(){msgCenter.send("\u00c9chec de sauvegarder tes configurations."),gui.prefSaveLoading.hide()})):alert("Tu dois \u00eatre connect\u00e9 pour pouvoir sauvegarder.")},gui.openAuthorBio=function(){gui.center.hasClass("show")||gui.center.addClass("show"),gui.author_bio.hasClass("show")||(gui.author_bio.siblings().removeClass("show"),gui.author_bio.addClass("show"),window.mse&&(mse.root.pause(),gui.updatePlayPauseIcon()))},gui.openCredits=function(){gui.center.hasClass("show")||gui.center.addClass("show"),gui.credits.hasClass("show")||(gui.credits.siblings().removeClass("show"),gui.credits.addClass("show"),window.mse&&(mse.root.pause(),gui.updatePlayPauseIcon()))},gui.openNextEp=function(){var a=$("#next_ep_dialog");gui.center.hasClass("show")||gui.center.addClass("show"),a.hasClass("show")||(a.siblings().removeClass("show"),a.addClass("show"),window.mse&&(mse.root.pause(),gui.updatePlayPauseIcon()))},gui.hideConcept=function(){gui.concept.removeClass("show");var a=!1;gui.center.children().each(function(){$(this).hasClass("show")&&(a=!0)}),a||gui.center.removeClass("show")},gui.openhideUploader=function(a){a&&a.stopPropagation(),gui.uploader.hasClass("show")?(gui.comment.unbind("click",gui.openhideUploader),gui.uploader.removeClass("show")):(gui.uploader.addClass("show"),gui.comment.click(gui.openhideUploader))},gui.updatePlayPauseIcon=function(){mse.root.inPause?gui.playpause.html('<img src="'+config.base_url+'assets/img/season13/ui/wheel_play.png"/>'):gui.playpause.html('<img src="'+config.base_url+'assets/img/season13/ui/wheel_pause.png"/>')},gui.isToolsOpen=function(){return gui.fblike.hasClass("active")},gui.openhideTools=function(){var a=gui.controler.find("li");a.eq(1).hasClass("active")?(a.removeClass("active"),$(this).removeClass("active")):(a.addClass("active"),$(this).addClass("active"))},gui.openComment=function(){gui.center.hasClass("show")||gui.center.addClass("show"),gui.comment.hasClass("show")||(gui.comment.addClass("show"),gui.comment.siblings().removeClass("show"),mse.root.pause(),gui.updatePlayPauseIcon(),0==gui.userComments.children("li").length&&gui.updateUsersComments(0))},gui.closeComment=function(){gui.comment_loading.removeClass("show"),gui.comment_menu.children("#commentImg").remove(),gui.comment_content.val("")},gui.updateUsersComments=function(a){a=isNaN(a)?gui.userComments.children("li").length:a,$.ajax({type:"GET",url:config.base_url+"13comments/comment_by_ep",data:{start:a,ep:mse.configs.epid},dataType:"json",success:function(a){if(a)if(0==a.success)a.errorMessage&&msgCenter.send(a.errorMessage);else if(1==a.success&&$.isArray(a.comments)){var e=a.comments;if(0==e.length)gui.userComments.children("#renew_comments").text("Plus d'anciens commentaires").unbind("click");else{for(var f=$(""),g=0;e.length>g;++g){var h=e[g];f=f.add(constructDomComment(h))}gui.userComments.children("#renew_comments").before(f)}}else{var d=$("<h5>Echec de r\u00e9cup\u00e9rer les commentaires</h5>");gui.userComments.children("#renew_comments").before(d),d.delay(1e3).fadeOut(400,function(){d.remove()})}else{var d=$("<h5>Echec de r\u00e9cup\u00e9rer les commentaires</h5>");gui.userComments.children("#renew_comments").before(d),d.delay(1e3).fadeOut(400,function(){d.remove()})}}})},gui.setCommentImage=function(a,b){"base64"!=b&&"path"!=b&&(b="path");var c=gui.comment_menu.children("#commentImg");0==c.length?(c=$('<li id="commentImg"><img class="preview" src="'+a+'"/></li>'),gui.comment_menu.append(c)):c.children("img").prop("src",a),c.children("img").attr("type",b),c.hide().fadeIn(500)},gui.postComment=function(a,b){function d(a){if(a)if(a.success){var b=a.posted;gui.userComments.prepend(constructDomComment(b)),gui.userComments.scrollTop(-gui.userComments.position().top),gui.comment_loading.removeClass("show");var c=null;c=fbapi.user&&gui.fbShareEnabled&&"0"!=b.fbpostid?$('<p>Ton message a bien \u00e9t\u00e9 post\u00e9 sur SEASON13 et sur Facebook. <a href="'+fbapi.user.link+'" target="_blank">Voir.</a></p>'):$("<p>Ton message a bien \u00e9t\u00e9 post\u00e9.</p>"),msgCenter.send(c)}else gui.comment_loading.removeClass("show"),msgCenter.send(a.errorMessage);else f(a,e)}function f(){"debug"==config.readerMode&&(console.log("ERROR WHILE POSTING COMMENT : "),console.log(arguments)),gui.comment_loading.removeClass("show"),msgCenter.send("Une erreur est survenue. Lors de l'envoie ou la recup\u00e9ration du commentaire.")}var c=JSON.stringify(mse.root.getProgress());return fbapi.user&&gui.fbShareEnabled?fbapi.post(a,b,c,d,f):(a?(null==b&&(b=""),$.post(config.base_url+"13comments/comment",{imgUrl:a,message:b,position:c,fbID:"",ep:mse.configs.epid},d,"json")):b&&$.post(config.base_url+"13comments/comment",{imgUrl:"",message:b,position:c,fbID:"",ep:mse.configs.epid},d,"json"),void 0)},$(document).ready(function(){if(initMseConfig(),gui.menu=$("#menu"),gui.center=$("#center"),gui.pref=$("#preference"),gui.prefSaveLoading=$("#preference .link .loading").hide(),gui.author_bio=$("#author_bio"),gui.credits=$("#credits"),gui.controler=$("#controler"),gui.comment=$("#comment"),gui.comment_menu=$("#comment_menu"),gui.comment_content=$("#comment_content"),gui.comment_loading=gui.comment.children(".loading"),gui.comment_share_btn=gui.comment_menu.children("#btn_share"),gui.userComments=$("#comment_list"),gui.uploader=$("#upload_container"),gui.uploadForm=$("#imageuploadform"),gui.playpause=$("#ctrl_playpause"),gui.speedup=$("#controler #ctrl_speedup"),gui.slowdown=$("#controler #ctrl_slowdown"),gui.commentbtn=$("#controler #ctrl_comment"),gui.fblike=$("#controler #ctrl_like"),gui.concept=$("#concept"),gui.currPlayState=!0,gui.fbShareEnabled=!0,gui.scriber&&gui.scriber.init(),gui.center.children().children(".close").click(function(){$(this).parent().removeClass("show"),mse.root.play(),gui.updatePlayPauseIcon();var a=!1;gui.center.children().each(function(){$(this).hasClass("show")&&(a=!0)}),a||gui.center.removeClass("show")}),gui.comment.children(".close").click(gui.closeComment),$("#icon_menu, #sep_right, #switch_menu").click(gui.openhideMenu),$("#btn_param").click(gui.openPref),gui.audioctrl=new gui.Slider(200,100,gui.pref.children("p:first"),50),gui.speedctrl=new gui.Slider(200,10,gui.pref.children("p:eq(1)"),5),gui.audioctrl.jqObj.css("left",70),gui.speedctrl.jqObj.css("left",70),window.mse&&(gui.audioctrl.observe("value",new Callback(mse.src.setVolume,mse.src)),mse.ArticleLayer.prototype.observe("speedLevel",new Callback(function(a){gui.speedctrl.setvalue(a)},null)),gui.speedctrl.observe("value",new Callback(function(a){mse.ArticleLayer.prototype.speedLevel=a},null))),$("#btn_author").click(gui.openAuthorBio),$("#btn_credits").click(gui.openCredits),$("#btn_nextep").click(gui.openNextEp),window.mse){gui.controler.children("#circle").click(gui.openhideTools);var b,a=gui.controler.children("#circle").children("span");gui.playpause.click(function(){mse.root.inPause?mse.root.play():mse.root.pause(),gui.currPlayState=!mse.root.inPause,gui.updatePlayPauseIcon()}),gui.speedup.click(function(){var c=mse.ArticleLayer.prototype.speedLevel+1;mse.ArticleLayer.prototype.setspeedLevel(c),a.text(c),b&&clearTimeout(b),a.animate({opacity:1},300),b=setTimeout(function(){a.animate({opacity:0},300)},1600)}),gui.slowdown.click(function(){var c=mse.ArticleLayer.prototype.speedLevel-1;mse.ArticleLayer.prototype.setspeedLevel(c),a.text(c),b&&clearTimeout(b),a.animate({opacity:1},300),b=setTimeout(function(){a.animate({opacity:0},300)},1600)}),$("#ctrl_like").click(function(){fbapi.like()}),gui.commentbtn.click(gui.openComment),gui.userComments.on("click",".comment_fblike",fbapi.commentLike),gui.pref.find("#share_comment_fb").change(function(){gui.fbShareEnabled=$(this).prop("checked"),gui.fbShareEnabled?gui.comment_share_btn.children("img").show():gui.comment_share_btn.children("img").hide()}),gui.comment_menu.children("#btn_capture_img").click(function(){gui.comment.removeClass("show"),mse.root.startCapture(new Callback(gui.scriber.showWithImg,gui.scriber))}),gui.comment_menu.children("#btn_upload_img").click(gui.openhideUploader),gui.uploader.click(function(a){a.stopPropagation()});var c={type:"POST",url:config.restUploadPath+"create_img",dataType:"json",success:function(a){gui.comment_loading.removeClass("show"),gui.uploadForm.get(0).reset(),gui.openhideUploader(),a.success?gui.setCommentImage(a.path,"path"):a.errorMessage&&msgCenter.send(a.errorMessage)},error:function(){gui.comment_loading.removeClass("show"),gui.uploadForm.get(0).reset(),gui.openhideUploader(),msgCenter.send("Erreur de t\u00e9l\u00e9chargement")}};gui.uploadForm.ajaxForm(c),$("#imageuploadform #upload_btn").click(function(){if(gui.comment_menu.children("#commentImg").length>0){var a=confirm("Tu vas remplacer l'image pr\u00e9c\u00e9demment t\u00e9l\u00e9charg\u00e9e, s\u00fbr?");if(!a)return}gui.uploadForm.submit(),gui.comment_loading.addClass("show")}),gui.comment_share_btn.click(function(){var a=gui.comment_menu.children("#commentImg").children("img"),b=a.prop("src"),c=a.attr("type");b=b&&""!=b.trim()?b:!1;var d=gui.comment_content.val();if(!b&&""==d)return msgCenter.send("Ton message est vide."),void 0;if(a.parent().remove(),gui.comment_content.val(""),gui.comment_loading.addClass("show"),b&&"base64"==c){var e={imgData64:b};fbapi.user&&(e.fbComment=!0),$.ajax({type:"POST",url:config.restUploadPath+"create_drawing",dataType:"json",data:e,success:function(a){a.success?(b=a.path,gui.postComment(b,d)):(gui.comment_loading.removeClass("show"),a.errorMessage&&msgCenter.send(a.errorMessage))},error:function(){gui.comment_loading.removeClass("show"),msgCenter.send("Erreur de t\u00e9l\u00e9chargement")}})}else gui.postComment(b,d)}),window.mse.root.init||(gui.downloadTimer=setTimeout(gui.downloadTimeout,2e4)),mse.root.evtDistributor.rootEvt.addListener("loadover",new Callback(gui.removeDownloadTimer,gui,gui.downloadTimer)),mse.root.evtDistributor.rootEvt.addListener("loadover",new Callback(gui.hideConcept,gui)),mse.root.evtDistributor.rootEvt.addListener("finished",new Callback(gui.openNextEp,gui))}window.mse&&window.mse.root.init||(gui.concept.addClass("show"),gui.center.addClass("show"))});var userData=function(){function c(a){if("debug"==config.readerMode){var b=window.open("_blank");b.document.open(),b.document.write(a.responseText),b.document.close()}}var a={},b=a;return $(window).unload(function(){a.save()}),$(document).ready(function(){a.retrieve(),$("#game_quit").click(a.save)}),b.save=function(a,b){$.post(config.base_url+"user/data/update",{speed:gui.speedctrl.value,fbShareEnabled:gui.fbShareEnabled,volume:gui.audioctrl.value,epId:config.episode.epid,position:window.mse&&window.mse.root?mse.root.getProgress():{},started:!0,completed:!1}).success("function"==typeof a?a:function(){}).error("function"==typeof b?b:c)},b.retrieve=function(){$.ajax({url:config.base_url+"user/data/retrieve",type:"GET",data:{epId:config.episode.epid},dataType:"json",success:function(a){if(a.config){var b=a.config;b.fbShareEnabled&&gui.pref.find("#share_comment_fb").prop("checked","true"==b.fbShareEnabled?!0:!1),b.speed&&gui.speedctrl.setvalue(parseInt(b.speed)),b.volume&&gui.audioctrl.setvalue(parseInt(b.volume))}},error:c})},b}();